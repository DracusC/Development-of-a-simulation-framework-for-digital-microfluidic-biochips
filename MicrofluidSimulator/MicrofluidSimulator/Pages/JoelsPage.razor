@page "/"
@page "/JoelsPage"
@using Microsoft.JSInterop
@using SimulatorCode
@using System.Text.Json.Serialization
@using MicrofluidSimulator.SimulatorCode.Simulator
@inject IJSRuntime JsRuntime
@inject HttpClient Http
@using MicrofluidSimulator.SimulatorCode.DataTypes
@using MicrofluidSimulator.SimulatorCode.View
@using System.Diagnostics


<h3>Welcome to the simulator</h3>

<div id="mainContent">
    <div id='container'></div>

    <div id="layerPanel">
        <div>
            <span>Layer Panel</span>
            <form name="test">
                <div>
                <input type="checkbox" name="colors" value="red"/>
                <label for="red">debug1</label>
                </div>
    
                <div>
                <input type="checkbox" name="colors" value="red"/>
                <label for="red">debug2</label>
                </div>
    
                <div>
                <input type="checkbox" name="colors" value="red"/>
                <label for="red">debug3</label>
                </div>

                <div>
                <input type="checkbox" name="colors" value="red"/>
                <label for="red">debug4</label>
                </div>

                <div>
                <input type="checkbox" name="colors" value="red"/>
                <label for="red">debug5</label>
                </div>

                <div>
                <input type="checkbox" name="colors" value="red"/>
                <label for="red">debug6</label>
                </div>
            </form>
        </div>
    </div>
</div>


<button id="nextStep" class="btn btn-primary" @onclick="NextStep">Next Step</button>
<button class="btn btn-primary" @onclick="Play">Play</button>
<RadzenSlider TValue="int" Min="-100" Max="100"></RadzenSlider>

<div id="list1" class="dropdown-check-list" tabindex="100">
  <span class="anchor">Debug Panel</span>
  <ul class="items">
    <li><input id="debug1" type="checkbox" />Debug1 </li>
    <li><input id="debug2" type="checkbox" />Debug2</li>
  </ul>
</div>








@functions{
    async void setP5() {
        await JsRuntime.InvokeAsync<object>("setp5");
    }
}

@code {


    public string[] selected { get; set; } = new String[] { };
    private void selectedItems(ChangeEventArgs e) {
        selected = (string[])e.Value;

        foreach(var s in selected) {
            Console.WriteLine(s);
        }
    }

    // ACTUAL CODE BELOW
    GUIBroker guibroker = new GUIBroker();

    bool test = true;
    Stopwatch stopwatch = new Stopwatch();

    private void NextStep() {
        if(test) { stopwatch.Start(); test = false; } else {stopwatch.Stop(); Console.WriteLine("SW: " + stopwatch.ElapsedMilliseconds); stopwatch.Reset(); test = true; }
        simulator.simulatorStep();
        guibroker.update_board(simulator.Container);
    }

    public void Play() {
        Console.WriteLine("Play called");
        guibroker.change_play_status();
    }

    private async Task RunNextSimulatorStep() {
        if (simulator.ActionQueue.Count != 0) {
            Console.WriteLine(simulator.ActionQueue.Count);
            NextStep();
        }
    }

    // Used to call C# code from JS
    private static Func<Task> CallPlaceHolder;
    protected override void OnInitialized() {
        base.OnInitialized();
        CallPlaceHolder = RunNextSimulatorStep;
    }
    [JSInvokable]
    public static async Task JSSimulatorNextStep() {
        await CallPlaceHolder.Invoke();
    }

    private JsonContainer? container;
    private Simulator? simulator;
    private MicrofluidSimulator.SimulatorCode.DataTypes.ElectrodesWithNeighbours[]? electrodesWithNeighbours;
    protected override async void OnAfterRender(bool firstRender) {
        Console.WriteLine("FIRST == " + firstRender);
        if(firstRender) {
            Console.WriteLine("TEST");
            setP5();
            container = await Http.GetFromJsonAsync<JsonContainer>("sample-data/platform640v1.json");
            electrodesWithNeighbours = await Http.GetFromJsonAsync<MicrofluidSimulator.SimulatorCode.DataTypes.ElectrodesWithNeighbours[]>("sample-data/platform640v1neighbours.json");
            simulator = new Simulator(null, container, electrodesWithNeighbours);

            guibroker.set_jsruntime(JsRuntime);
            guibroker.update_board(simulator.Container);
            guibroker.initialize_board(container.information);
        }
    }
}